<?php
/**
 * Template: Single Event (CPT: event_listing)
 * PHASE 5: Migrated to ViewModel Architecture
 * Matches approved design: eventos - evento - single.html
 * Uses ViewModel data transformation and shared partials
 */

defined('ABSPATH') || exit;

// Initialize autoloader for ViewModels
require_once plugin_dir_path(__DIR__) . 'apollo-core/src/class-apollo-autoloader.php';
Apollo_Autoloader::init();

// Check if we have a valid event
if (!have_posts()) {
    status_header(404);
    nocache_headers();
    include get_404_template();
    exit;
}

// Get the current event post
the_post();
global $post;

// Create ViewModel for single event
$viewModel = Apollo_ViewModel_Factory::create_from_data($post, 'single_event');
$template_data = $viewModel->get_single_event_data();

// Load shared partials
$template_loader = new Apollo_Template_Loader();
$template_loader->load_partial('assets');
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes">
    <title><?php echo esc_html($template_data['title']); ?> - Apollo::rio</title>
    <link rel="icon" href="https://assets.apollo.rio.br/img/neon-green.webp" type="image/webp">
    <?php $template_loader->load_partial('assets'); ?>

    <!-- Leaflet for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* Mobile-first responsive container */
        .mobile-container {
            width: 100%;
            min-height: 100vh;
            background: var(--bg-main, #fff);
        }

        @media (min-width: 888px) {
            body {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding: 5rem 0 0rem;
                background: var(--bg-surface, #f5f5f5);
            }
            .mobile-container {
                max-width: 500px;
                width: 100%;
                background: var(--bg-main, #fff);
                box-shadow: 0 0 60px rgba(0,0,0,0.1);
                border-radius: 2rem;
                overflow: hidden;
            }
        }

        /* Hero section */
        .hero-section {
            position: relative;
            width: 100%;
            height: 75vh;
            overflow: hidden;
        }

        .hero-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 2rem;
            color: white;
        }

        .hero-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            opacity: 0.9;
        }

        /* Event details */
        .event-details {
            padding: 2rem;
        }

        .event-description {
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .event-meta {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .meta-item i {
            color: var(--primary, #007bff);
            font-size: 1.25rem;
        }

        /* Lineup section */
        .lineup-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .lineup-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .lineup-grid {
            display: grid;
            gap: 1rem;
        }

        .artist-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-surface, #f5f5f5);
            border-radius: var(--radius-main, 12px);
        }

        .artist-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .artist-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .artist-role {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.7;
        }

        /* Gallery section */
        .gallery-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .gallery-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-main, 12px);
        }

        /* Map section */
        .map-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .map-container {
            height: 300px;
            border-radius: var(--radius-main, 12px);
            overflow: hidden;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 888px) {
            .hero-section {
                height: 60vh;
            }

            .hero-title {
                font-size: 1.5rem;
            }

            .event-details,
            .lineup-section,
            .gallery-section,
            .map-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="mobile-container">
        <!-- Hero Section -->
        <?php if ($template_data['hero']): ?>
            <section class="hero-section">
                <?php if ($template_data['hero']['media_url']): ?>
                    <img src="<?php echo esc_url($template_data['hero']['media_url']); ?>"
                         alt="<?php echo esc_attr($template_data['hero']['title']); ?>"
                         class="hero-media">
                <?php endif; ?>

                <div class="hero-overlay">
                    <h1 class="hero-title"><?php echo esc_html($template_data['hero']['title']); ?></h1>
                    <?php if ($template_data['hero']['subtitle']): ?>
                        <p class="hero-subtitle"><?php echo esc_html($template_data['hero']['subtitle']); ?></p>
                    <?php endif; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Event Details -->
        <section class="event-details">
            <?php if ($template_data['details']['description']): ?>
                <div class="event-description">
                    <?php echo wp_kses_post($template_data['details']['description']); ?>
                </div>
            <?php endif; ?>

            <div class="event-meta">
                <?php if ($template_data['details']['date_time']): ?>
                    <div class="meta-item">
                        <i class="ri-calendar-event-line"></i>
                        <span><?php echo esc_html($template_data['details']['date_time']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['venue']): ?>
                    <div class="meta-item">
                        <i class="ri-map-pin-2-line"></i>
                        <span><?php echo esc_html($template_data['details']['venue']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['venue_address']): ?>
                    <div class="meta-item">
                        <i class="ri-navigation-line"></i>
                        <span><?php echo esc_html($template_data['details']['venue_address']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['price']): ?>
                    <div class="meta-item">
                        <i class="ri-money-dollar-circle-line"></i>
                        <span><?php echo esc_html($template_data['details']['price']); ?></span>
                    </div>
                <?php endif; ?>
            </div>
        </section>

        <!-- Lineup Section -->
        <?php if (!empty($template_data['lineup'])): ?>
            <section class="lineup-section">
                <h2 class="lineup-title">Line-up</h2>
                <div class="lineup-grid">
                    <?php foreach ($template_data['lineup'] as $artist): ?>
                        <div class="artist-card">
                            <?php if ($artist['avatar']): ?>
                                <img src="<?php echo esc_url($artist['avatar']); ?>"
                                     alt="<?php echo esc_attr($artist['name']); ?>"
                                     class="artist-avatar">
                            <?php else: ?>
                                <div class="artist-avatar" style="background: var(--bg-surface); display: flex; align-items: center; justify-content: center;">
                                    <i class="ri-user-line" style="font-size: 1.5rem; opacity: 0.5;"></i>
                                </div>
                            <?php endif; ?>

                            <div class="artist-info">
                                <h4><?php echo esc_html($artist['name']); ?></h4>
                                <p class="artist-role"><?php echo esc_html($artist['role']); ?></p>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Gallery Section -->
        <?php if (!empty($template_data['gallery'])): ?>
            <section class="gallery-section">
                <h2 class="gallery-title">Galeria</h2>
                <div class="gallery-grid">
                    <?php foreach ($template_data['gallery'] as $image): ?>
                        <div class="gallery-item">
                            <img src="<?php echo esc_url($image['url']); ?>"
                                 alt="<?php echo esc_attr($image['alt']); ?>"
                                 loading="lazy">
                        </div>
                    <?php endforeach; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Map Section -->
        <?php if ($template_data['details']['venue_address']): ?>
            <section class="map-section">
                <h2 class="map-title">Localização</h2>
                <div id="event-map" class="map-container"></div>
            </section>
        <?php endif; ?>

        <!-- Bottom Bar -->
        <?php if ($template_data['bottom_bar']): ?>
            <?php $template_loader->load_partial('bottom-bar', $template_data['bottom_bar']); ?>
        <?php endif; ?>
    </div>

    <?php wp_footer(); ?>

    <script>
        // Initialize map if venue address exists
        <?php if ($template_data['details']['venue_address']): ?>
        document.addEventListener('DOMContentLoaded', function() {
            // Simple geocoding and map initialization
            // In production, you'd want to use a proper geocoding service
            const map = L.map('event-map').setView([-22.9068, -43.1729], 13); // Default to Rio

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker for venue (simplified - in production use geocoding API)
            L.marker([-22.9068, -43.1729])
                .addTo(map)
                .bindPopup('<?php echo esc_js($template_data['details']['venue']); ?>')
                .openPopup();
        });
        <?php endif; ?>
    </script>
</body>
</html>

<?php wp_reset_postdata(); ?>
        /* Mobile-first responsive container */
        .mobile-container {
            width: 100%;
            min-height: 100vh;
            background: var(--bg-main, #fff);
        }

        @media (min-width: 888px) {
            body {
                display: flex;
                justify-content: center;
                align-items: flex-start;
                min-height: 100vh;
                padding: 5rem 0 0rem;
                background: var(--bg-surface, #f5f5f5);
            }
            .mobile-container {
                max-width: 500px;
                width: 100%;
                background: var(--bg-main, #fff);
                box-shadow: 0 0 60px rgba(0,0,0,0.1);
                border-radius: 2rem;
                overflow: hidden;
            }
        }

        /* Hero section */
        .hero-section {
            position: relative;
            width: 100%;
            height: 75vh;
            overflow: hidden;
        }

        .hero-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .hero-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
            padding: 2rem;
            color: white;
        }

        .hero-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .hero-subtitle {
            opacity: 0.9;
        }

        /* Event details */
        .event-details {
            padding: 2rem;
        }

        .event-description {
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .event-meta {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .meta-item i {
            color: var(--primary, #007bff);
            font-size: 1.25rem;
        }

        /* Lineup section */
        .lineup-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .lineup-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .lineup-grid {
            display: grid;
            gap: 1rem;
        }

        .artist-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-surface, #f5f5f5);
            border-radius: var(--radius-main, 12px);
        }

        .artist-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        .artist-info h4 {
            margin: 0;
            font-size: 1rem;
            font-weight: 600;
        }

        .artist-role {
            margin: 0;
            font-size: 0.875rem;
            opacity: 0.7;
        }

        /* Gallery section */
        .gallery-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .gallery-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .gallery-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: var(--radius-main, 12px);
        }

        /* Map section */
        .map-section {
            padding: 2rem;
            border-top: 1px solid var(--border-color, #e0e2e4);
        }

        .map-container {
            height: 300px;
            border-radius: var(--radius-main, 12px);
            overflow: hidden;
        }

        /* Mobile responsive adjustments */
        @media (max-width: 888px) {
            .hero-section {
                height: 60vh;
            }

            .hero-title {
                font-size: 1.5rem;
            }

            .event-details,
            .lineup-section,
            .gallery-section,
            .map-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="mobile-container">
        <!-- Hero Section -->
        <?php if ($template_data['hero']): ?>
            <section class="hero-section">
                <?php if ($template_data['hero']['media_url']): ?>
                    <img src="<?php echo esc_url($template_data['hero']['media_url']); ?>"
                         alt="<?php echo esc_attr($template_data['hero']['title']); ?>"
                         class="hero-media">
                <?php endif; ?>

                <div class="hero-overlay">
                    <h1 class="hero-title"><?php echo esc_html($template_data['hero']['title']); ?></h1>
                    <?php if ($template_data['hero']['subtitle']): ?>
                        <p class="hero-subtitle"><?php echo esc_html($template_data['hero']['subtitle']); ?></p>
                    <?php endif; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Event Details -->
        <section class="event-details">
            <?php if ($template_data['details']['description']): ?>
                <div class="event-description">
                    <?php echo wp_kses_post($template_data['details']['description']); ?>
                </div>
            <?php endif; ?>

            <div class="event-meta">
                <?php if ($template_data['details']['date_time']): ?>
                    <div class="meta-item">
                        <i class="ri-calendar-event-line"></i>
                        <span><?php echo esc_html($template_data['details']['date_time']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['venue']): ?>
                    <div class="meta-item">
                        <i class="ri-map-pin-2-line"></i>
                        <span><?php echo esc_html($template_data['details']['venue']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['venue_address']): ?>
                    <div class="meta-item">
                        <i class="ri-navigation-line"></i>
                        <span><?php echo esc_html($template_data['details']['venue_address']); ?></span>
                    </div>
                <?php endif; ?>

                <?php if ($template_data['details']['price']): ?>
                    <div class="meta-item">
                        <i class="ri-money-dollar-circle-line"></i>
                        <span><?php echo esc_html($template_data['details']['price']); ?></span>
                    </div>
                <?php endif; ?>
            </div>
        </section>

        <!-- Lineup Section -->
        <?php if (!empty($template_data['lineup'])): ?>
            <section class="lineup-section">
                <h2 class="lineup-title">Line-up</h2>
                <div class="lineup-grid">
                    <?php foreach ($template_data['lineup'] as $artist): ?>
                        <div class="artist-card">
                            <?php if ($artist['avatar']): ?>
                                <img src="<?php echo esc_url($artist['avatar']); ?>"
                                     alt="<?php echo esc_attr($artist['name']); ?>"
                                     class="artist-avatar">
                            <?php else: ?>
                                <div class="artist-avatar" style="background: var(--bg-surface); display: flex; align-items: center; justify-content: center;">
                                    <i class="ri-user-line" style="font-size: 1.5rem; opacity: 0.5;"></i>
                                </div>
                            <?php endif; ?>

                            <div class="artist-info">
                                <h4><?php echo esc_html($artist['name']); ?></h4>
                                <p class="artist-role"><?php echo esc_html($artist['role']); ?></p>
                            </div>
                        </div>
                    <?php endforeach; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Gallery Section -->
        <?php if (!empty($template_data['gallery'])): ?>
            <section class="gallery-section">
                <h2 class="gallery-title">Galeria</h2>
                <div class="gallery-grid">
                    <?php foreach ($template_data['gallery'] as $image): ?>
                        <div class="gallery-item">
                            <img src="<?php echo esc_url($image['url']); ?>"
                                 alt="<?php echo esc_attr($image['alt']); ?>"
                                 loading="lazy">
                        </div>
                    <?php endforeach; ?>
                </div>
            </section>
        <?php endif; ?>

        <!-- Map Section -->
        <?php if ($template_data['details']['venue_address']): ?>
            <section class="map-section">
                <h2 class="map-title">Localização</h2>
                <div id="event-map" class="map-container"></div>
            </section>
        <?php endif; ?>

        <!-- Bottom Bar -->
        <?php if ($template_data['bottom_bar']): ?>
            <?php $template_loader->load_partial('bottom-bar', $template_data['bottom_bar']); ?>
        <?php endif; ?>
    </div>

    <?php wp_footer(); ?>

    <script>
        // Initialize map if venue address exists
        <?php if ($template_data['details']['venue_address']): ?>
        document.addEventListener('DOMContentLoaded', function() {
            // Simple geocoding and map initialization
            // In production, you'd want to use a proper geocoding service
            const map = L.map('event-map').setView([-22.9068, -43.1729], 13); // Default to Rio

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Add marker for venue (simplified - in production use geocoding API)
            L.marker([-22.9068, -43.1729])
                .addTo(map)
                .bindPopup('<?php echo esc_js($template_data['details']['venue']); ?>')
                .openPopup();
        });
        <?php endif; ?>
    </script>
</body>
</html>

<?php wp_reset_postdata(); ?>
		if ( $venue_id ) {
			$la = get_post_meta( $venue_id, '_venue_lat', true );
			$ln = get_post_meta( $venue_id, '_venue_lng', true );
			if ( $la !== '' && $ln !== '' ) {
				$lat = (float) str_replace( ',', '.', (string) $la );
				$lng = (float) str_replace( ',', '.', (string) $ln );
			}
		}
	}

	$coords = array(
		'lat' => $lat,
		'lng' => $lng,
	);

	$coords = apply_filters( 'apollo_event_map_coords', $coords, $event_id );

	if ( ! isset( $coords['lat'], $coords['lng'] ) ) {
		$coords = array(
			'lat' => null,
			'lng' => null,
		);
	}

	return $coords;
}

/**
 * Lineup + timetable resolver
 */
function apollo_event_get_dj_slots( $event_id ) {
	$event_id = (int) $event_id;

	$slots = get_post_meta( $event_id, '_event_dj_slots', true );
	if ( ! is_array( $slots ) ) {
		$slots = array();
	}

	$clean = array();

	foreach ( $slots as $slot ) {
		if ( ! is_array( $slot ) ) {
			continue;
		}

		$dj_id = isset( $slot['dj_id'] ) ? (int) $slot['dj_id'] : 0;
		if ( ! $dj_id ) {
			continue;
		}

		$start = isset( $slot['start'] ) ? sanitize_text_field( (string) $slot['start'] ) : '';
		$end   = isset( $slot['end'] ) ? sanitize_text_field( (string) $slot['end'] ) : '';

		$clean[] = array(
			'dj_id' => $dj_id,
			'start' => $start,
			'end'   => $end,
		);
	}

	// If empty, fallback to simple list
	if ( empty( $clean ) ) {
		$djs = get_post_meta( $event_id, '_event_djs', true );
		if ( is_array( $djs ) ) {
			foreach ( $djs as $dj_id ) {
				$dj_id = (int) $dj_id;
				if ( $dj_id ) {
					$clean[] = array(
						'dj_id' => $dj_id,
						'start' => '',
						'end'   => '',
					);
				}
			}
		}
	}

	$clean = apply_filters( 'apollo_event_dj_slots', $clean, $event_id );

	if ( ! is_array( $clean ) ) {
		$clean = array();
	}

	// Sort by start time if available
	usort(
		$clean,
		function ( $a, $b ) {
			$as = isset( $a['start'] ) ? $a['start'] : '';
			$bs = isset( $b['start'] ) ? $b['start'] : '';
			if ( $as === '' && $bs === '' ) {
				return 0;
			}
			if ( $as === '' ) {
				return 1;
			}
			if ( $bs === '' ) {
				return -1;
			}
			return strcmp( $as, $bs );
		}
	);

	return $clean;
}

function apollo_initials( $name ) {
	$name = trim( (string) $name );
	if ( $name === '' ) {
		return 'DJ';
	}
	$parts   = preg_split( '/\s+/', $name );
	$letters = '';
	foreach ( $parts as $p ) {
		$letters .= mb_substr( $p, 0, 1 );
		if ( mb_strlen( $letters ) >= 2 ) {
			break;
		}
	}
	return mb_strtoupper( $letters );
}

while ( have_posts() ) :
	the_post();

	$event_id = get_the_ID();

	// Core fields
	$event_title = get_the_title();

	// Meta candidates (adjust in plugin)
	$event_city    = get_post_meta( $event_id, '_event_city', true );
	$event_address = get_post_meta( $event_id, '_event_address', true );

	$event_date_display = get_post_meta( $event_id, '_event_date_display', true );
	$event_start_time   = get_post_meta( $event_id, '_event_start_time', true );
	$event_end_time     = get_post_meta( $event_id, '_event_end_time', true );
	$event_tz_label     = get_post_meta( $event_id, '_event_tz_label', true );

	$youtube_url = get_post_meta( $event_id, '_event_youtube_url', true );
	if ( ! $youtube_url ) {
		$youtube_url = get_post_meta( $event_id, '_event_video_url', true );
	}
	$youtube_embed = apollo_build_youtube_embed_url( $youtube_url );

	$featured_img = get_the_post_thumbnail_url( $event_id, 'full' );
	if ( ! $featured_img ) {
		$featured_img = 'https://assets.apollo.rio.br/img/default-event.jpg';
	}

	// Tickets / links
	$tickets_url   = get_post_meta( $event_id, '_event_ticket_url', true );
	$guestlist_url = get_post_meta( $event_id, '_event_guestlist_url', true );

	// Coupon
	$coupon_code = get_post_meta( $event_id, '_event_coupon_code', true );
	if ( $coupon_code === '' ) {
		$coupon_code = 'APOLLO';
	}

	// Interested users
	$interested_ids   = apollo_event_get_interested_user_ids( $event_id );
	$total_interested = count( $interested_ids );
	$max_visible      = 10;
	$visible_ids      = array_slice( $interested_ids, 0, $max_visible );
	$hidden_count     = max( 0, $total_interested - count( $visible_ids ) );

	// Is current user interested?
	$current_user_id = get_current_user_id();
	$is_interested   = ( $current_user_id && in_array( $current_user_id, $interested_ids, true ) );

	// Map coords
	$coords = apollo_event_get_coords( $event_id );

	// DJ slots
	$dj_slots = apollo_event_get_dj_slots( $event_id );

	// Sounds tags (taxonomy example)
	$sounds = array();
	$terms  = get_the_terms( $event_id, 'event_sounds' );
	if ( is_array( $terms ) ) {
		foreach ( $terms as $t ) {
			$sounds[] = $t->name;
		}
	}

	// Gallery images (use featured + attached images)
	$gallery_images = array();
	if ( $featured_img ) {
		$gallery_images[] = $featured_img;
	}
	$attachments = get_attached_media( 'image', $event_id );
	foreach ( $attachments as $attachment ) {
		$gallery_images[] = wp_get_attachment_url( $attachment->ID );
	}
	// Ensure at least 5 for carousel
	while ( count( $gallery_images ) < 5 ) {
		$gallery_images[] = $featured_img ?: 'https://assets.apollo.rio.br/img/default-event.jpg';
	}
	$gallery_images = array_slice( $gallery_images, 0, 5 );

	// Venue images (same as gallery for now)
	$venue_images = $gallery_images;

	// Format date for display
	$display_date = $event_date_display;
	if ( ! $display_date && get_the_date() ) {
		$display_date = get_the_date( 'j M \'y' );
	}

	// Format time
	$display_time = '';
	if ( $event_start_time && $event_end_time ) {
		$display_time = $event_start_time . ' - ' . $event_end_time;
	} elseif ( $event_start_time ) {
		$display_time = $event_start_time;
	}

	// Venue name
	$venue_name = $event_city ?: 'Local TBA';

endwhile;
wp_reset_postdata();
?>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes">
	<title><?php echo esc_html( $event_title ); ?> - Apollo::rio</title>
	<link rel="icon" href="https://assets.apollo.rio.br/img/neon-green.webp" type="image/webp">
	<link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet">
	<!-- UNI.CSS (Apollo Global Design System - base utilities only) -->
	<link rel="stylesheet" href="https://assets.apollo.rio.br/uni.css">
	<script src="https://assets.apollo.rio.br/base.js"></script>
	<style>
		* {
			-webkit-tap-highlight-color: transparent; corner-shape:squircle;
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		:root {
			--font-primary: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', sans-serif;
			--bg-main: #fff;
			--bg-surface: #f5f5f5;
			--text-primary: rgba(19, 21, 23, .85);
			--text-secondary: rgba(19, 21, 23, .7);
			--border-color: #e0e2e4;
			--border-color-2: #e0e2e454;
			--radius-main: 12px;
			--radius-card: 16px;
			--transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
			--card-shadow-light: rgba(0, 0, 0, 0.05);
		}
		i {margin:1px 0 -1px 0}

		html, body {
			font-family: var(--font-primary);
			font-size: 15px;
			color: var(--text-secondary);
			background-color: #f2f2f2;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='a' width='20' height='20' patternTransform='scale(1.8)' patternUnits='userSpaceOnUse'%3E%3Crect width='100%25' height='100%25' fill='none'/%3E%3Cpath fill='none' stroke='rgba(0, 0, 0, 0.02)' d='M10 0v20M0 10h20'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='800%25' height='800%25' fill='url(%23a)'/%3E%3C/svg%3E");
			-webkit-font-smoothing: antialiased;
			scroll-behavior: smooth;
		}

		/* Mobile Container */
		@media (min-width: 888px) {
			body {
				display: flex;
				justify-content: center;
				align-items: flex-start;
				min-height: 100vh;
				padding: 5rem 0 0rem;
			}
			.mobile-container {
				max-width: 500px;
				width: 100%;
				background: #fff;
				box-shadow: 0 0 60px rgba(0,0,0,0.1);
				border-radius: 2rem;
				overflow: hidden;
			}
		}

		@media (max-width: 888px) {
			.mobile-container {
				width: 100%;
				min-height: 100vh;
			}
		}

		/* Hero Section */
		.hero-media {
			position: relative;
			width: 100%;
			height: 75vh;
			overflow: hidden;
			background: #000;
		}

		.hero-media iframe,
		.hero-media img {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			object-fit: cover;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		}

		.hero-media iframe {
			pointer-events: none;
			transform: scale(1.5);

		}

		.hero-overlay {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, transparent 30%, transparent 70%, rgba(0,0,0,0.8) 100%);
			z-index: 1;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		}

		.hero-content {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			padding: 2rem 1.5rem;
			z-index: 2;
			color: white;
		}

		.event-tag-pill {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.22rem .4rem 0.19rem .3rem;
			background: linear-gradient(17deg, rgba(255,255,255,0.3), transparent);
			backdrop-filter: blur(15px);
			border-radius: 0.65rem;
			border:1px solid #ffffff1a;
			font-size: 0.54rem;
			font-weight: 500;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			margin-bottom: 0.3rem;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		& i {
			font-size: 0.95rem;
		margin: 0 -2px 0 2px;
		}
		}
		.hero-title {
			font-size: clamp(3.2rem, 8vw, 3.2rem);
			font-weight: 900;
			line-height: 1;
			margin: 0.5rem 0;
			text-shadow: 0 4px 20px rgba(0,0,0,0.5);
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		}

		.hero-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
			font-size: 0.8rem;
			font-weight: 400;
			padding: 0px 0.2em 2em 0.2em;
		margin:0 auto;
		}

		.hero-meta-item {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
			& .yoha {margin-left:.8rem;}
			& i {opacity:0.5; font-size:1.12rem;}
		}

		/* Event Body */
		.event-body {
			background: var(--bg-main);
			border-radius: 2rem 2rem 0 0;
			margin-top: -2.5rem;
			position: relative;
			z-index: 3;
			padding: 10px 0px;
		}

		/* Quick Actions - APOLLO STYLE */
		.quick-actions {
			display: grid;
			grid-template-columns: repeat(4, auto);
			gap: 0.33rem;
			padding: 2rem 1.5rem;
			aspec-ratio:1/1;
		}

		.quick-action {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 0rem;
			text-decoration: none;
			color: var(--text-secondary);
			transition: var(--transition);
		}

		.quick-action:hover {
			color: var(--text-primary);
		}

		.quick-action-icon {
			width: 60px;
			height: 60px;
			background: transparent;
			border: 1px solid var(--border-color);
			border-radius: 1rem;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			transition: var(--transition);
		}

		.quick-action-icon:hover {
			background: var(--bg-surface);
			transform: translateY(-4px);
			box-shadow: 0 4px 12px var(--card-shadow-light);
		}

		.quick-action-icon i {
			font-size: 1.5rem;
			color: var(--text-primary);
		}

		.quick-action-label {
			font-size: 0.65rem;
			color:#ddddddcc;
			font-weight: 400;
			text-transform: uppercase;
			letter-spacing: 1.2px;
			text-align: center;
		}

		/* RSVP Row with Avatar Explosion */
		.rsvp-row {
			padding: 1.2rem 2rem 4.5rem;
			justify-content:right;
				display: flex;
		}

		.avatars-explosion {
			display: flex;
			position:absolute;
			right:115px;
			flex-wrap: wrap;
			margin-bottom: 1rem;
		}

		.avatar {
			width: 42px;
			height: 42px;
			border-radius: 49%;
			corner-shape:squircle;
			border: 0px solid #fff;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			margin-left: -12px;
			transition: transform 0.3s ease;
			background-size: cover;
			background-position: center;
		}

		.avatar:first-child {
			margin-left: 0;
		}

		.avatar:hover {
			transform: scale(1.15) translateY(-4px);
			z-index: 10;
		}

		.avatar-count {
			width: 42px;
			height: 42px;
			border-radius: 50%;
			background: var(--text-primary);
			color: white;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.65rem;
			font-weight: 500;
			border: 3px solid #fff;
			margin-left: -15px;
		}

		.interested-text {
			display: flex;
			position:absolute;
			right:-70px;
			top:10px;
			align-items: center;
			gap: 0.5rem;
			font-size: 0.9rem;
			color: var(--text-secondary);
			font-weight: 500;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		}

		/* Section Styles */
		.section {display:relative;
			padding: 2rem 1.5rem;
			user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
		}

		.section-title {
			font-size: 1.5rem;
			font-weight: 700;
			margin-bottom: 1.25rem;
			display: flex;
			align-items: center;
			gap: 0.75rem;
			color: var(--text-primary);
		}

		.section-title i {
			font-size: 1.75rem;
			opacity: 0.7;
		}

		/* Info Card */
		.info-card {
			background: var(--bg-surface);
			border-radius: var(--radius-card);
			padding: 1.5rem;
			margin-bottom: 1rem;
		}

		.info-text {
			font-size: 1rem;
			line-height: 1.6;
			color: var(--text-secondary);
		}

		/* Music Tags Marquee */
		.music-tags-marquee {
			overflow: hidden;
			white-space: nowrap;
			margin-top: 1rem;
			-webkit-mask-image: linear-gradient(90deg, transparent, #000 20%, #000 80%, transparent);
			mask-image: linear-gradient(90deg, transparent, #000 20%, #000 80%, transparent);
		}

		.music-tags-track {
			display: inline-flex;
			gap: 1rem;
			animation: marquee 20s linear infinite;
		}

		@keyframes marquee {
			from { transform: translateX(0); }
			to { transform: translateX(-50%); }
		}

		.music-tag {
			padding: 0.4rem 0.8rem;
			background: transparent;
			border-radius: 999px;
			font-size: 0.7rem;
			font-weight: 600;
			text-transform: uppercase;
			color: var(--text-secondary);
			border: 1px solid var(--border-color);
		}

		/* Promo Gallery */
		.promo-gallery-slider {
			position: relative;
			overflow: hidden;
			border-radius: var(--radius-card);
			height: 300px;
		}

		.promo-track {
			display: flex;
			transition: transform 0.5s ease;
			height: 100%;
		}

		.promo-slide {
			flex-shrink: 0; padding: 0.6rem; border-radius: 8px;
			width: 100%;
			height: 100%;
		}

		.promo-slide img { padding: 1rem; border-radius: 8px;
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.promo-controls {
			position: absolute;
			bottom: 1rem;
			right: 3rem;
			display: flex;
			gap: 0.5rem;
			z-index: 10;
			text-shadow: 2px 2px 13px black;

		}

		.promo-prev, .promo-next {
			width: 25px;
			height: 25px;
			border-radius: 50%;
			background: #eeeeee1a;
			backdrop-filter: blur(10px);
			border: none;
			color: #eeeeee80;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.25rem;
			transition: var(--transition);
			text-shadow: 2px 2px 13px black;
		}

		.promo-prev:hover, .promo-next:hover {
			background: rgba(0,0,0,0.7);
		}

		/* Lineup - APOLLO STYLE */
		.lineup-list {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}

		.lineup-card {
			background: var(--bg-surface);
			border-radius: var(--radius-card);

			display: flex;
			align-items: center;
			gap: 1rem;
			transition: var(--transition);
			min-height:85px;
			padding:0 .5rem;
		}

		.lineup-card:hover {
			box-shadow: 0 4px 12px var(--card-shadow-light);
		}

		.lineup-avatar-img {
			width: auto;
			height: 100%;
			max-height:65px;
			border-radius: 12px;
			object-fit: cover;
			flex-shrink: 0;

		}

		.lineup-avatar-fallback {
			width: 64px;
			height: 64px;
			border-radius: 12px;
			background: var(--bg-surface);
			border: 0px solid var(--border-color);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.75rem;
			color: var(--text-primary);
			font-weight: 700;
			flex-shrink: 0;
		}

		.lineup-info {
			flex: 1;
			margin-left:16px;
		}

		.lineup-name {
			font-size: 1.125rem;
			font-weight: 700;
			margin-bottom: 0.25rem;
		}

		.dj-link {
			color: var(--text-primary);
			text-decoration: none;
			transition: color 0.3s ease;
		}

		.dj-link:hover {
			color: var(--text-secondary);
		}

		.lineup-time {
			font-size: 0.875rem;
			color: var(--text-secondary);
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		/* Venue Images Slider - 5 IMAGES */
		.local-images-slider {
			position: relative;
			overflow: hidden;
			border-radius: var(--radius-card);
			height: 350px;
			background: #000;
			margin-bottom: 1.5rem;
			z-index:15;
		}

		.local-images-track {
			display: flex;
			transition: transform 0.5s ease;
			height: 100%;
		}

		.local-image {
			flex-shrink: 0;
			width: 100%;
			height: 100%;
		}

		.local-image img {
			width: 100%;
			height: 100%;
			object-fit: cover;
		}

		.slider-nav {
			position: absolute;
			bottom: 1rem;
			left: 50%;
			transform: translateX(-50%);
			display: flex;
			gap: 0.5rem;
			z-index: 10;
		}

		.slider-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: rgba(255,255,255,0.5);
			cursor: pointer;
			transition: var(--transition);
		}

		.slider-dot.active {
			background: white;
			width: 24px;
			border-radius: 4px;
		}

		/* Route Controls - APOLLO STYLE (EXACT MATCH) */
		.route-controls {
			display: flex;
			gap: 0px;
			margin-top: 1.5rem;
		}

		.route-input {
			height: 48px;
			border-radius: 12px 0px 0px 12px;
			background-color: transparent;
			border: 1px solid var(--border-color);border-right: none;
			display: flex;
			align-items: center;
			padding: 0 20px;
			gap: 10px;
			flex: 1;
			transition: var(--transition);
		}

		.route-input:focus-within {
			border-color: var(--text-primary); border-right: none;
			box-shadow: 0 0 0 2px var(--border-color-2);
		}

		.route-input input {
			background: none;
			border: none;
			flex: 1;
			font-size: 0.87rem;
			color: var(--text-primary);
			outline: none;


		.route-input i {
			font-size: 1.8rem;
			opacity: 0.5;
		} }

		.route-button {
			height: 48px;
			padding: 6px 18px;
			border-radius:12px;
			text-transform: uppercase;
			background:rgb(240, 240, 240);
			color: #13131380;
			border: 1px solid rgb(224, 226, 228); border-left: none;
			font-weight: 600;
			font-size:1.2rem;
			cursor: pointer;
			transition: var(--transition);
			display: flex;
			align-items: center;
			gap: 8px;
			white-space: nowrap;
			transition: color .5s ease-in-out, filter .5s ease-in-out;
		&:hover {background: var(--text-secondary); color:#fdfdfd;  filter: brightness(1.08);}
			&:hover:active {background:#fff; color:#000;filter:brightness(1.8); transform:scale(1.02);}
		}
		/* Tickets Section - NO PRICES, NEUTRAL APOLLO STYLE */

.ticket-card {
	background: var(--bg-surface);
	border: 1px solid var(--border-color);
	border-radius: var(--radius-card);
	padding: 1rem;
	margin-top:1.45rem;
	text-decoration: none;
	display: flex;
	flex-direction: row;
	align-items: center;
	justify-content: flex-start;
	text-align: left;
	transition: var(--transition);
	filter:contrast(0.8);
	user-select: none;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
&:hover {
	transform: translateY(4px);
	box-shadow: 0 10px 30px var(--card-shadow-light);
	border: 1px solid #3434341a;
	filter:contrast(1) brightness(1.02);}
}

.disabled {
	cursor: default;
	pointer-events: none;
	touch-action: none;
	transition: none;
	opacity:.5;
	filter:contrast(1) brightness(1);
	&:hover{filter:contrast(1) brightness(1);}
	&.ticket-name{opacity:.4}
}


.ticket-icon {
	width: 50px;
	height: 50px;
	border-radius: 50%;
	background: var(--bg-surface);
	border: 2px solid var(--border-color);
	display: flex;
	align-items: center;
	justify-content: center;
	margin-right: 1rem;
}

.ticket-icon i {
	font-size: 1.75rem;
	color: var(--text-primary);
}

.ticket-info {
	display: flex;
	flex-direction: column;
	align-items: flex-start;
}

.ticket-name {
	font-size: 1.25rem;
	font-weight: 700;
	margin-bottom: 0.25rem;
	color: var(--text-primary);
}

.ticket-cta {
	font-size: 0.875rem;
	font-weight: 600;
	color: var(--text-secondary);
}
		/* Apollo Coupon Detail */
		.apollo-coupon-detail {
			background: rgba(247, 148, 27, 0.08);
			border: 1px dashed var(--border-color);
			border-radius: 0px 0px 12px 12px;
			padding: .5rem .6rem 0.3rem 0.6rem;
			display: flex;
			margin: -0.2rem auto 0.2rem auto;
			align-items: center;
			gap: 0.84rem;
			font-size: 0.78rem;
			width:96%;
			corner-shape:squircle;
				letter-spacing: .5px;
	}

		.apollo-coupon-detail span { margin:auto; align-text:center}

		.apollo-coupon-detail .ri-coupon-3-line {
			font-size: .99rem;
			padding: .3rem 0rem;
			color: var(--text-secondary);
			transform:rotate(145deg);
		}

		.apollo-coupon-detail strong {
			font-size: 0.75rem;
			position:relative;
			display:inline-flex;
			font-weight: 800;
			text-align: center;
			margin:auto;
			color: var(--text-primary);
			letter-spacing: 1px;
		}

		.copy-code-mini {
			background: transparent;
			border: none;
			color: var(--text-secondary);
			border-radius: 3px;
			width: 17px;
			height: 17px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			margin-left: auto;
			transition: var(--transition);
			transform:rotate(0deg);
			& i {font-size:1.05rem}
			& .ri-file-copy-fill{}
		}

		.copy-code-mini:hover {
			background: var(--text-secondary);
		}

		/* Secondary Image */
		.secondary-image {
			border-radius: var(--radius-card);
			overflow: hidden;
		}

		.secondary-image img {
			width: 100%;
			height: auto;
			display: block;
		}

		/* Bottom Bar - APOLLO STYLE */
		.bottom-bar {
			position: fixed;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			width: 100%;
			max-width: 500px;
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(20px);
			padding: 1rem 1.5rem;
			box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
			z-index: 100;
			display: flex;
			gap: 0.75rem;
			border-radius: 22px 22px 0 0;
		}

		.bottom-btn {
			flex: 1;
			padding: 1rem;
			border-radius: var(--radius-main);
			border: 1px solid var(--border-color);
			font-weight: 700;
			font-size: 0.95rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			transition: var(--transition);
			text-decoration: none;
			background: var(--bg-main);
			color: var(--text-primary);
		}

		.bottom-btn:active {
			transform: scale(0.97);
		}

		.bottom-btn:hover {
			background: var(--bg-surface);
			border-color: var(--text-secondary);
		}

		.bottom-btn.primary {
			background: var(--text-primary);
			color: white;
			border-color: var(--text-primary);
		}

		.bottom-btn.primary:hover {
			background: var(--text-secondary);
			border-color: var(--text-secondary);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.hero-media {
				height: 60vh;
			}

			.quick-actions {
				grid-template-columns: repeat(4, auto);
				gap: 0rem;
				padding: 0.1rem 1rem 0 1rem;
				margin: 1.5rem auto 0px auto;
			}
			.rsvp-row {
			padding: 2rem 2rem 2rem;
				margin:0.7rem auto;

		}
			.tickets-grid {
				grid-template-columns: 1fr;
			}

			.interested-text {
			right:-55px;}
			.avatars-explosion {
		right:70px;}

			.promo-gallery-slider {
				height: 200px;
			}

			.local-images-slider {
				height: 250px;
			}

			.avatar {
				width: 36px;
				height: 36px;
			}

			.lineup-avatar-img,
			.lineup-avatar-fallback {
				width: 30%;
				height: 60px;
				font-size: 1.5rem;
			}
		}
	</style>
</head>
<body>
	<div class="mobile-container">

		<!-- HERO_MEDIA -->
		<div class="hero-media">
			<div class="video-cover">
	<?php if ( $youtube_embed ) : ?>
	<iframe
		src="<?php echo esc_url( $youtube_embed ); ?>"
		allow="autoplay; fullscreen"
		allowfullscreen
		frameborder="0"
	></iframe>
	<?php else : ?>
	<img src="<?php echo esc_url( $featured_img ); ?>" alt="<?php echo esc_attr( $event_title ); ?>">
	<?php endif; ?>
	</div>
			<div class="hero-overlay"></div>
			<div class="hero-content">
				<h1 class="hero-title"><?php echo esc_html( $event_title ); ?></h1>
				<div class="hero-meta">
					<?php if ( $display_date ) : ?>
					<div class="hero-meta-item">
						<i class="ri-calendar-line"></i>
						<span><?php echo esc_html( $display_date ); ?></span>
					</div>
					<?php endif; ?>
					<?php if ( $display_time ) : ?>
					<div class="hero-meta-item">
						<i class="ri-time-line"></i>
						<span><?php echo esc_html( $display_time ); ?><font style="opacity:.7;font-weight:300; font-size:.81rem; vertical-align: bottom;">(GMT-03h00)</font></span>
					</div>
					<?php endif; ?>
					<?php if ( $venue_name ) : ?>
					<div class="hero-meta-item">
						<i class="ri-map-pin-line"></i>
						<span><?php echo esc_html( $venue_name ); ?></span>
					</div>
					<?php endif; ?>
				</div>
			</div>
		</div>

		<!-- EVENT_BODY -->
		<div class="event-body">

			<!-- QUICK_ACTIONS -->
			<div class="quick-actions">
				<a href="#route_TICKETS" class="quick-action">
					<div class="quick-action-icon">
						<i class="ri-ticket-2-line"></i>
					</div>
					<span class="quick-action-label">TICKETS</span>
				</a>
				<a href="#route_LINE" class="quick-action">
					<div class="quick-action-icon">
						<i class="ri-draft-line"></i>
					</div>
					<span class="quick-action-label">Line-up</span>
				</a>
				<a href="#route_ROUTE" class="quick-action">
					<div class="quick-action-icon">
						<i class="ri-treasure-map-line"></i>
					</div>
					<span class="quick-action-label">ROUTE</span>
				</a>
				<a href="#" class="quick-action" id="favoriteTrigger">
					<div class="quick-action-icon">
						<i class="ri-rocket-line"></i>
					</div>
					<span class="quick-action-label">Interesse</span>
				</a>
			</div>

			<!-- RSVP_AVATARS -->
<div class="rsvp-row">
	<div class="avatars-explosion">
		<?php
		$avatar_index = 0;
		foreach ( $visible_ids as $user_id ) :
			$user = get_user_by( 'id', $user_id );
			if ( ! $user ) {
				continue;
			}
			$avatar_url = get_avatar_url( $user_id, array( 'size' => 42 ) );
			?>
		<div class="avatar" style="background-image: url('<?php echo esc_url( $avatar_url ); ?>')"></div>
			<?php
			++$avatar_index;
			if ( $avatar_index >= $max_visible ) {
				break;
			}
		endforeach;
		if ( $hidden_count > 0 ) :
			?>
		<div class="avatar-count">+<?php echo esc_html( $hidden_count ); ?></div>
		<?php endif; ?>
		<p class="interested-text" style="margin: 0 8px 0px 20px;">
			<i class="ri-bar-chart-2-fill"></i> <span id="result"><?php echo esc_html( $total_interested ); ?></span>
		</p>
	</div>
</div>

			<!-- Info Section -->
			<section class="section">
				<h2 class="section-title">
					<i class="ri-brain-ai-3-fill"></i> Info
				</h2>
				<div class="info-card">
					<p class="info-text"><?php echo wp_kses_post( get_the_content() ); ?></p>
				</div>
				<?php if ( ! empty( $sounds ) ) : ?>
				<div class="music-tags-marquee">
					<div class="music-tags-track">
						<?php
						$all_sounds = array_merge( $sounds, $sounds ); // Duplicate for infinite loop
						foreach ( $all_sounds as $sound ) :
							?>
						<span class="music-tag"><?php echo esc_html( $sound ); ?></span>
						<?php endforeach; ?>
					</div>
				</div>
				<?php endif; ?>
			</section>

<!-- Promo Gallery -->
<div class="promo-gallery-slider">
<div class="promo-track" id="promoTrack">
<?php foreach ( $gallery_images as $index => $img_url ) : ?>
<div class="promo-slide"> <img src="<?php echo esc_url( $img_url ); ?>" alt="Promo <?php echo $index + 1; ?>"></div>
<?php endforeach; ?>
</div>

<div class="promo-controls">
	<button class="promo-prev"><i class="ri-arrow-left-s-line"></i></button>
	<button class="promo-next"><i class="ri-arrow-right-s-line"></i></button>
</div>
</div>

	<!-- DJ Lineup -->
			<section class="section" id="route_LINE"><h2 class="section-title"><i class="ri-disc-line"></i> Line-up</h2><div class="lineup-list">
<?php
foreach ( $dj_slots as $slot ) :
	$dj_id   = $slot['dj_id'];
	$dj_post = get_post( $dj_id );
	if ( ! $dj_post ) {
		continue;
	}
	$dj_name      = get_the_title( $dj_id );
	$dj_image     = get_the_post_thumbnail_url( $dj_id, 'full' );
	$time_display = '';
	if ( $slot['start'] && $slot['end'] ) {
		$time_display = $slot['start'] . ' - ' . $slot['end'];
	} elseif ( $slot['start'] ) {
		$time_display = $slot['start'];
	}
	?>
<div class="lineup-card">
	<?php if ( $dj_image ) : ?>
<img src="<?php echo esc_url( $dj_image ); ?>" alt="<?php echo esc_attr( $dj_name ); ?>" class="lineup-avatar-img">
<?php else : ?>
<div class="lineup-avatar-fallback"><?php echo esc_html( apollo_initials( $dj_name ) ); ?></div>
<?php endif; ?>
<div class="lineup-info">
<h3 class="lineup-name"><a href="<?php echo esc_url( get_permalink( $dj_id ) ); ?>" target="_blank" class="dj-link"><?php echo esc_html( $dj_name ); ?></a></h3>
	<?php if ( $time_display ) : ?>
<div class="lineup-time"><i class="ri-time-line"></i><span><?php echo esc_html( $time_display ); ?></span></div>
<?php endif; ?>
</div>
</div>
<?php endforeach; ?>
</div>
</section>

<!-- Venue Section -->
			<section class="section" id="route_ROUTE">
				<h2 class="section-title">
					<i class="ri-map-pin-2-line"></i> <?php echo esc_html( $venue_name ); ?>
				</h2>
				<p style="margin:0.5rem 0 1.5rem 0; font-size:0.95rem;"><?php echo esc_html( $event_address ?: 'Endereço não informado' ); ?></p>

<!-- Images Slider -->
<div class="local-images-slider">
<div class="local-images-track" id="localTrack">
<?php foreach ( $venue_images as $index => $img_url ) : ?>
<div class="local-image">
<img src="<?php echo esc_url( $img_url ); ?>" alt="Venue <?php echo $index + 1; ?>"></div>
<?php endforeach; ?>
</div>

<div class="slider-nav" id="localDots"></div>
</div>

<!-- Map View -->
<div class="map-view" id="map-view" style="margin:00px auto 0px auto; z-index:0; background:green;width:100%; height:285px;border-radius:12px;background-image:url('https://img.freepik.com/premium-vector/city-map-scheme-background-flat-style-vector-illustration_833641-2300.jpg'); background-size: cover;background-repeat: no-repeat;background-position: center center; "></div>

<!-- Route Input -->
<div class="route-controls" style="transform:translateY(-80px); padding:0 0.5rem;">
<div class="route-input glass">
<i class="ri-map-pin-line"></i>
<input type="text" id="origin-input" placeholder="Seu endereço de partida">
</div>

<button id="route-btn" class="route-button"><i class="ri-send-plane-line"></i></button>
</div>
</section>

<!-- Tickets Section -->
<section class="section" id="route_TICKETS">
<h2 class="section-title">
<i class="ri-ticket-2-line" style="margin:2px 0 -2px 0"></i> Acessos
				</h2>

<!-- Ticket Cards -->
<?php if ( $tickets_url ) : ?>
<a href="<?php echo esc_url( $tickets_url ); ?>?ref=apollo.rio.br" class="ticket-card" target="_blank">
<div class="ticket-icon"><i class="ri-ticket-line"></i></div>
<div class="ticket-info">
<h3 class="ticket-name"><span id="changingword">Biglietti</span></h3><span class="ticket-cta">Acessar Bilheteria Digital →</span></div>
</a>
<?php endif; ?>

	<!-- Apollo Coupon Detail -->
<?php if ( $coupon_code ) : ?>
<div class="apollo-coupon-detail">
<i class="ri-coupon-3-line"></i>
<span>Verifique se o cupom <strong><?php echo esc_html( $coupon_code ); ?></strong> está ativo com desconto</span>
<button class="copy-code-mini" onclick="copyPromoCode()">
<i class="ri-file-copy-fill"></i>
</button>
</div>
<?php endif; ?>

<!-- Lista Amiga -->
<?php if ( $guestlist_url ) : ?>
<div class="ticket-card disabled">
<div class="ticket-icon">
<i class="ri-list-check"></i>
</div>
<div class="ticket-info">
<h3 class="ticket-name">Lista Amiga</h3>
<span class="ticket-cta">Ver Lista Amiga →</span>
</div>
</div>
<?php endif; ?>
</section>

<!-- Final Event Image -->
<section class="section">
<div class="secondary-image">
<img src="<?php echo esc_url( $featured_img ); ?>" alt="<?php echo esc_attr( $event_title ); ?>">
</div>
</section>
</div>

<!-- Bottom Bar -->
<div class="bottom-bar">
<a href="#route_TICKETS" class="bottom-btn primary" id="bottomTicketBtn">
<i class="ri-ticket-fill"></i>
<span id="changingword">Tickets</span>
</a>

<script>
(function(){
	var words = [
	'Entradas',
	'Ingressos',
	'Billets',
	'Ticket',
	'Acessos',
	'Biglietti'
	], i = 0;
	var elem = document.getElementById('changingword');
	// set initial word
	if (elem) {
	elem.textContent = words[i];
	}
	function fadeOut(el, duration, callback) {
	el.style.opacity = 1;
	var start = null;
	function step(timestamp) {
		if (!start) start = timestamp;
		var progress = timestamp - start;
		var fraction = progress / duration;
		if (fraction < 1) {
		el.style.opacity = 1 - fraction;
		window.requestAnimationFrame(step);
		} else {
		el.style.opacity = 0;
		if (callback) callback();
		}
	}
	window.requestAnimationFrame(step);
	}
	function fadeIn(el, duration, callback) {
	el.style.opacity = 0;
	el.style.display = '';
	var start = null;
	function step(timestamp) {
		if (!start) start = timestamp;
		var progress = timestamp - start;
		var fraction = progress / duration;
		if (fraction < 1) {
		el.style.opacity = fraction;
		window.requestAnimationFrame(step);
		} else {
		el.style.opacity = 1;
		if (callback) callback();
		}
	}
	window.requestAnimationFrame(step);
	}
	setInterval(function(){
	if (!elem) return;
	fadeOut(elem, 400, function(){
		i = (i+1) % words.length;
		elem.textContent = words[i];
		fadeIn(elem, 400);
	});
	}, 4000);
})();
</script>

<button class="bottom-btn secondary" id="bottomShareBtn">
<i class="ri-share-forward-line"></i>
</button>
</div>
</div>

<script>
		'use strict';
		// Promo Gallery Slider
		const promoTrack = document.getElementById('promoTrack');
		const promoSlides = promoTrack?.children.length || 0;
		let currentPromo = 0;
		document.querySelector('.promo-prev')?.addEventListener('click', () => {
			currentPromo = (currentPromo - 1 + promoSlides) % promoSlides;
			promoTrack.style.transform = `translateX(-${currentPromo * 100}%)`;
		});
		document.querySelector('.promo-next')?.addEventListener('click', () => {
			currentPromo = (currentPromo + 1) % promoSlides;
			promoTrack.style.transform = `translateX(-${currentPromo * 100}%)`;
		});
		// Venue Images Slider (5 images with infinite loop)
		const localTrack = document.getElementById('localTrack');
		const localDots = document.getElementById('localDots');
		if (localTrack && localTrack.children.length > 0) {
			const slides = localTrack.children;
			const slideCount = slides.length;
			let currentSlide = 0;
			// Create dots
			for(let i = 0; i < slideCount; i++) {
				const dot = document.createElement('div');
				dot.classList.add('slider-dot');
				if(i === 0) dot.classList.add('active');
dot.addEventListener('click', () => goToSlide(i));
localDots.appendChild(dot);
			}
			function goToSlide(index) {
				currentSlide = index;
				localTrack.style.transition = 'transform 0.5s ease';
				localTrack.style.transform = `translateX(-${index * 100}%)`;
				updateDots();
			}
			function updateDots() {   document.querySelectorAll('.slider-dot').forEach((dot, i) => {
					dot.classList.toggle('active', i === currentSlide);
				});
			}
// Auto-advance with true infinite loop
			setInterval(() => {
				currentSlide++;
if(currentSlide >= slideCount) {
localTrack.style.transition = 'none';
					currentSlide = 0;
localTrack.style.transform = `translateX(0)`;
	localTrack.offsetHeight;
setTimeout(() => {
currentSlide = 1;
localTrack.style.transition = 'transform 0.5s ease';
localTrack.style.transform = `translateX(-100%)`;
updateDots();
					}, 50);
				} else {
					goToSlide(currentSlide);
				}
			}, 4000);
		}
		// Route Button
		const routeBtn = document.getElementById('route-btn');
		if (routeBtn) { routeBtn.addEventListener('click', () => {
				const originInput = document.getElementById('origin-input');
				const origin = originInput.value;
				if (origin) {
					const destination = encodeURIComponent('<?php echo esc_js( $event_address ?: $venue_name ); ?>');
					window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${destination}`, '_blank');
				} else {
					originInput.placeholder = 'Por favor, insira um endereço!';
					setTimeout(() => {
						originInput.placeholder = 'Seu endereço de partida';
					}, 2000);
				}
			});
		}
		// Copy Promo Code
		function copyPromoCode() {
			const code = '<?php echo esc_js( $coupon_code ); ?>';
			navigator.clipboard.writeText(code).then(() => {
				const btn = event.target.closest('.copy-code-mini');
				const originalHTML = btn.innerHTML;
				btn.innerHTML = '<i class="ri-check-line"></i>';
				setTimeout(() => {
					btn.innerHTML = originalHTML;
				}, 2000);
			});
		}
// Share Function
document.getElementById('bottomShareBtn')?.addEventListener('click', () => {
			if (navigator.share) {
				navigator.share({
					title: '<?php echo esc_js( $event_title ); ?>',
					text: 'Confere esse evento no Apollo::rio!',
					url: window.location.href
				});
			} else {
				navigator.clipboard.writeText(window.location.href);
				alert('Link copiado!');
			}
		});
// Bottom Ticket Button Smooth Scroll
document.getElementById('bottomTicketBtn')?.addEventListener('click', (e) => {
			e.preventDefault();
document.getElementById('route_TICKETS').scrollIntoView({
				behavior: 'smooth',
				block: 'start'
			});
		});

// Interest toggle
document.getElementById('favoriteTrigger').addEventListener('click', function(event) {
	event.preventDefault();

	const iconContainer = this.querySelector('.quick-action-icon');
	const icon = iconContainer.querySelector('i');
	const avatarsContainer = document.querySelector('.avatars-explosion');
	const countEl = avatarsContainer.querySelector('.avatar-count');
	const resultEl = document.getElementById('result');
	const maxVisible = 10;

	function updateResult() {
	const visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
	const hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
	resultEl.textContent = visibleCount + hiddenCount;
	}

	if (icon.classList.contains('ri-rocket-line')) {
	// Favorite action
	iconContainer.classList.add('fly-away');

	setTimeout(() => {
		iconContainer.classList.remove('fly-away');
		icon.className = 'ri-ai-agent-fill fade-in';
		iconContainer.style.borderColor = 'rgba(0,0,0,0.2)';
	}, 1500);

	let hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
	let visibleCount = avatarsContainer.querySelectorAll('.avatar').length;

	if (visibleCount < maxVisible) {
		const newAvatar = document.createElement('div');
		newAvatar.classList.add('avatar');
		const gender = Math.random() < 0.5 ? 'men' : 'women';
		const id = Math.floor(Math.random() * 99) + 1;
		newAvatar.style.backgroundImage = `url('https://randomuser.me/api/portraits/${gender}/${id}.jpg')`;
		avatarsContainer.insertBefore(newAvatar, countEl);
	} else {
		hiddenCount += 1;
		countEl.textContent = `+${hiddenCount}`;
	}

	updateResult();
	} else {
	// Unfavorite action
	let hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
	let visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
	let total = visibleCount + hiddenCount;

	if (total > 0) {
		if (hiddenCount > 0) {
		hiddenCount -= 1;
		countEl.textContent = hiddenCount > 0 ? `+${hiddenCount}` : '';
		} else if (visibleCount > 0) {
		const lastAvatar = avatarsContainer.querySelector('.avatar:last-of-type');
		if (lastAvatar) lastAvatar.remove();
		}
		updateResult();
	}

	icon.className = 'ri-rocket-line fade-in';
	}
});

// Initial update
const avatarsContainer = document.querySelector('.avatars-explosion');
const countEl = avatarsContainer.querySelector('.avatar-count');
const resultEl = document.getElementById('result');

function initialUpdateResult() {
	const visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
	const hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
	resultEl.textContent = visibleCount + hiddenCount;
}

initialUpdateResult();
</script>
</body>
</html>	// Duplicate to simulate continuous marquee if few items
	if (count($sounds) > 0 && count($sounds) < 6) {
		$orig = $sounds;
		while (count($sounds) < 8) {
			$sounds = array_merge($sounds, $orig);
		}
		$sounds = array_slice($sounds, 0, 8);
	}

	$ajax_url = admin_url('admin-ajax.php');
	$nonce = wp_create_nonce('apollo_event_interest_' . $event_id);

	?>
<!doctype html>
<html <?php language_attributes(); ?>>
<head>
	<meta charset="<?php bloginfo( 'charset' ); ?>" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5, user-scalable=yes">
	<title><?php echo esc_html( $event_title ); ?> - <?php bloginfo( 'name' ); ?></title>

	<link rel="icon" href="https://assets.apollo.rio.br/img/neon-green.webp" type="image/webp">
	<link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet">
	<link rel="stylesheet" href="https://assets.apollo.rio.br/uni.css">

	<?php wp_head(); ?>

	<style>
		/* ==========================================================
			APOLLO EVENT SINGLE (CPT: event_listing)
			- Pure CSS, no Tailwind, no SCSS nesting (no "&")
			========================================================== */

		* {
			-webkit-tap-highlight-color: transparent;
			corner-shape:squircle;
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		:root {
			--font-primary: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Oxygen, Ubuntu, Cantarell, "Helvetica Neue", sans-serif;
			--bg-main: #fff;
			--bg-surface: #f5f5f5;
			--text-primary: rgba(19, 21, 23, .85);
			--text-secondary: rgba(19, 21, 23, .7);
			--border-color: #e0e2e4;
			--border-color-2: #e0e2e454;
			--radius-main: 12px;
			--radius-card: 16px;
			--transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
			--card-shadow-light: rgba(0, 0, 0, 0.05);
		}

		html, body {
			font-family: var(--font-primary);
			font-size: 15px;
			color: var(--text-secondary);
			background-color: #f2f2f2;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3Cpattern id='a' width='20' height='20' patternTransform='scale(1.8)' patternUnits='userSpaceOnUse'%3E%3Crect width='100%25' height='100%25' fill='none'/%3E%3Cpath fill='none' stroke='rgba(0, 0, 0, 0.02)' d='M10 0v20M0 10h20'/%3E%3C/pattern%3E%3C/defs%3E%3Crect width='800%25' height='800%25' fill='url(%23a)'/%3E%3C/svg%3E");
			-webkit-font-smoothing: antialiased;
			scroll-behavior: smooth;
		}

		i { margin: 1px 0 -1px 0; }

		@media (min-width: 888px) {
			body {
				display: flex;
				justify-content: center;
				align-items: flex-start;
				min-height: 100vh;
				padding: 5rem 0 0rem;
			}
			.mobile-container {
				max-width: 500px;
				width: 100%;
				background: #fff;
				box-shadow: 0 0 60px rgba(0,0,0,0.1);
				border-radius: 2rem;
				overflow: hidden;
			}
		}

		@media (max-width: 888px) {
			.mobile-container {
				width: 100%;
				min-height: 100vh;
			}
		}

		/* ---------------- HERO ---------------- */
		.hero-media {
			position: relative;
			width: 100%;
			height: 75vh;
			overflow: hidden;
			background: #000;
		}

		.video-cover {
			position: absolute;
			top: 50%;
			left: 50%;
			width: 100vw;
			height: 56.25vw; /* 16:9 */
			min-height: 100vh;
			min-width: 177.77vh;
			transform: translate(-50%, -50%);
			overflow: hidden;
		}

		.video-cover iframe,
		.video-cover img {
			position: absolute;
			inset: 0;
			border: 0;
			object-fit: cover;
			pointer-events: none;
			user-select: none;
		}

		.hero-overlay {
			position: absolute;
			inset: 0;
			background: linear-gradient(to bottom,
				rgba(0,0,0,0.3) 0%,
				transparent 30%,
				transparent 70%,
				rgba(0,0,0,0.8) 100%
			);
			z-index: 1;
			user-select: none;
		}

		.hero-content {
			position: absolute;
			bottom: 0;
			left: 0;
			width: 100%;
			padding: 2rem 1.5rem;
			z-index: 2;
			color: #fff;
		}

		.event-tag-pill {
			display: inline-flex;
			align-items: center;
			gap: 0.5rem;
			padding: 0.22rem 0.4rem 0.19rem 0.3rem;
			background: linear-gradient(17deg, rgba(255,255,255,0.3), transparent);
			backdrop-filter: blur(15px);
			border-radius: 0.65rem;
			border: 1px solid rgba(255,255,255,0.10);
			font-size: 0.54rem;
			font-weight: 500;
			text-transform: uppercase;
			letter-spacing: 0.2em;
			margin-bottom: 0.4rem;
			user-select: none;
		}
		.event-tag-pill i {
			font-size: 0.95rem;
			margin: 0 -2px 0 2px;
		}

		.hero-title {
			font-size: clamp(3.2rem, 8vw, 3.2rem);
			font-weight: 900;
			line-height: 1;
			margin: 0.5rem 0;
			text-shadow: 0 4px 20px rgba(0,0,0,0.5);
			user-select: none;
		}

		.hero-meta {
			display: flex;
			flex-wrap: wrap;
			gap: 1rem;
			font-size: 0.8rem;
			font-weight: 400;
			padding: 0 0.2em 2em 0.2em;
			margin:0 auto;
		}

		.hero-meta-item {
			display: flex;
			align-items: center;
			gap: 0.5rem;
			user-select: none;
		}
		.hero-meta-item i { opacity: .55; font-size: 1.12rem; }
		.hero-meta-item .yoha {margin-left:.8rem;}
		.hero-meta-item i {opacity:0.5; font-size:1.12rem;}

		/* ---------------- BODY ---------------- */
		.event-body {
			background: var(--bg-main);
			border-radius: 2rem 2rem 0 0;
			margin-top: -2.5rem;
			position: relative;
			z-index: 3;
			padding: 10px 0px;
		}

		.quick-actions {
			display: grid;
			grid-template-columns: repeat(4, auto);
			gap: 0.33rem;
			padding: 2rem 1.5rem;
		}

		.quick-action {
			display: flex;
			flex-direction: column;
			align-items: center;
			gap: 0;
			text-decoration: none;
			color: var(--text-secondary);
			transition: var(--transition);
		}
		.quick-action:hover { color: var(--text-primary); }

		.quick-action-icon {
			width: 60px;
			height: 60px;
			background: transparent;
			border: 1px solid var(--border-color);
			border-radius: 1rem;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			transition: var(--transition);
		}
		.quick-action-icon:hover {
			background: var(--bg-surface);
			transform: translateY(-4px);
			box-shadow: 0 4px 12px var(--card-shadow-light);
		}
		.quick-action-icon i { font-size: 1.5rem; color: var(--text-primary); }

		.quick-action-label {
			font-size: 0.65rem;
			color: #ddddddcc;
			font-weight: 400;
			text-transform: uppercase;
			letter-spacing: 1.2px;
			text-align: center;
		}

		/* RSVP avatars */
		.rsvp-row {
			padding: 1.2rem 2rem 4.5rem;
			justify-content: right;
			display: flex;
			position: relative;
		}

		.avatars-explosion {
			display: flex;
			position: absolute;
			right: 115px;
			flex-wrap: wrap;
			margin-bottom: 1rem;
			align-items: center;
		}

		.avatar {
			width: 42px;
			height: 42px;
			border-radius: 49%;
			border: 0;
			box-shadow: 0 2px 8px rgba(0,0,0,0.15);
			margin-left: -12px;
			transition: transform 0.3s ease;
			background-size: cover;
			background-position: center;
		}
		.avatar:first-child { margin-left: 0; }
		.avatar:hover { transform: scale(1.15) translateY(-4px); z-index: 10; }

		.avatar-count {
			width: 42px;
			height: 42px;
			border-radius: 50%;
			background: var(--text-primary);
			color: #fff;
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 0.65rem;
			font-weight: 500;
			border: 3px solid #fff;
			margin-left: -15px;
		}

		.interested-text {
			display: flex;
			position: absolute;
			right: -70px;
			top: 10px;
			align-items: center;
			gap: 0.5rem;
			font-size: 0.9rem;
			color: var(--text-secondary);
			font-weight: 500;
			user-select: none;
		}

		.section {
			padding: 2rem 1.5rem;
			user-select: none;
		}

		.section-title {
			font-size: 1.5rem;
			font-weight: 800;
			margin-bottom: 1.25rem;
			display: flex;
			align-items: center;
			gap: 0.75rem;
			color: var(--text-primary);
		}
		.section-title i { font-size: 1.75rem; opacity: 0.7; }

		.info-card {
			background: var(--bg-surface);
			border-radius: var(--radius-card);
			padding: 1.5rem;
			margin-bottom: 1rem;
		}

		.info-text {
			font-size: 1rem;
			line-height: 1.6;
			color: var(--text-secondary);
		}

		/* Sounds marquee */
		.music-tags-marquee {
			overflow: hidden;
			white-space: nowrap;
			margin-top: 1rem;
			-webkit-mask-image: linear-gradient(90deg, transparent, #000 20%, #000 80%, transparent);
			mask-image: linear-gradient(90deg, transparent, #000 20%, #000 80%, transparent);
		}
		.music-tags-track {
			display: inline-flex;
			gap: 1rem;
			animation: marquee 20s linear infinite;
		}
		@keyframes marquee {
			from { transform: translateX(0); }
			to   { transform: translateX(-50%); }
		}
		.music-tag {
			padding: 0.4rem 0.8rem;
			background: transparent;
			border-radius: 999px;
			font-size: 0.7rem;
			font-weight: 600;
			text-transform: uppercase;
			color: var(--text-secondary);
			border: 1px solid var(--border-color);
		}

		/* Lineup */
		.lineup-list {
			display: flex;
			flex-direction: column;
			gap: 1rem;
		}
		.lineup-card {
			background: var(--bg-surface);
			border-radius: var(--radius-card);
			display: flex;
			align-items: center;
			gap: 1rem;
			transition: var(--transition);
			min-height: 85px;
			padding: 0 .7rem;
		}
		.lineup-card:hover { box-shadow: 0 4px 12px var(--card-shadow-light); }
		.lineup-avatar-img {
			width: auto;
			height: 100%;
			max-height: 65px;
			border-radius: 12px;
			object-fit: cover;
			flex-shrink: 0;
		}
		.lineup-avatar-fallback {
			width: 72px;
			height: 72px;
			border-radius: 12px;
			background: rgba(255,255,255,.7);
			display: flex;
			align-items: center;
			justify-content: center;
			font-size: 1.1rem;
			color: var(--text-primary);
			font-weight: 900;
			flex-shrink: 0;
		}
		.lineup-info { flex: 1; min-width: 0; }
		.lineup-name { font-size: 1.05rem; font-weight: 900; margin-bottom: 0.25rem; color: var(--text-primary); }
		.dj-link { color: var(--text-primary); text-decoration: none; transition: color .3s ease; }
		.dj-link:hover { color: var(--text-secondary); }
		.lineup-time {
			font-size: 0.875rem;
			color: var(--text-secondary);
			display: flex;
			align-items: center;
			gap: 0.5rem;
		}

		/* Venue images */
		.local-images-slider {
			position: relative;
			overflow: hidden;
			border-radius: var(--radius-card);
			height: 350px;
			background: #000;
			margin-bottom: 1.2rem;
			z-index: 15;
		}
		.local-images-track {
			display: flex;
			transition: transform 0.5s ease;
			height: 100%;
		}
		.local-image { flex-shrink: 0; width: 100%; height: 100%; }
		.local-image img { width: 100%; height: 100%; object-fit: cover; }

		.slider-nav {
			position: absolute;
			bottom: 1rem;
			left: 50%;
			transform: translateX(-50%);
			display: flex;
			gap: 0.5rem;
			z-index: 10;
		}
		.slider-dot {
			width: 8px;
			height: 8px;
			border-radius: 50%;
			background: rgba(255,255,255,0.5);
			cursor: pointer;
			transition: var(--transition);
		}
		.slider-dot.active {
			background: #fff;
			width: 24px;
			border-radius: 4px;
		}

		/* MAP (OSM) overlay over background image */
		.ap-map-shell {
			position: relative;
			width: 100%;
			height: 285px;
			border-radius: 12px;
			overflow: hidden;
			background: #111;
		}
		.ap-map-bg {
			position: absolute;
			inset: 0;
			background-image: url('https://img.freepik.com/premium-vector/city-map-scheme-background-flat-style-vector-illustration_833641-2300.jpg');
			background-size: cover;
			background-repeat: no-repeat;
			background-position: center center;
			filter: saturate(0.9) contrast(0.9);
			opacity: 0.65;
			z-index: 0;
		}
		.ap-map-canvas {
			position: absolute;
			inset: 0;
			z-index: 2;
		}
		.ap-map-overlay-fade {
			position: absolute;
			inset: 0;
			z-index: 3;
			pointer-events: none;
			background: linear-gradient(to top, rgba(0,0,0,0.22), transparent 55%);
		}

		/* Route controls */
		.route-controls {
			display: flex;
			gap: 0;
			margin-top: 1.2rem;
			padding: 0 0.5rem;
			transform: translateY(-80px);
		}
		.route-input {
			height: 48px;
			border-radius: 12px 0 0 12px;
			background-color: transparent;
			border: 1px solid var(--border-color);
			border-right: none;
			display: flex;
			align-items: center;
			padding: 0 20px;
			gap: 10px;
			flex: 1;
			transition: var(--transition);
		}
		.route-input:focus-within {
			border-color: var(--text-primary);
			border-right: none;
		}
		.route-input input {
			background: none;
			border: none;
			flex: 1;
			font-size: 0.87rem;
			color: var(--text-primary);
			outline: none;
		}
		.route-input i { font-size: 1.2rem; opacity: 0.55; }

		.route-button {
			height: 48px;
			padding: 6px 18px;
			border-radius: 12px;
			text-transform: uppercase;
			background: rgb(240, 240, 240);
			color: rgba(19,19,19,0.5);
			border: 1px solid rgb(224, 226, 228);
			border-left: none;
			font-weight: 600;
			font-size: 1.2rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 8px;
			white-space: nowrap;
			transition: var(--transition);
		}
		.route-button:hover {
			background: var(--text-secondary);
			color: #fdfdfd;
			filter: brightness(1.08);
		}
		.route-button:active {
			background: #fff;
			color: #000;
			filter: brightness(1.8);
			transform: scale(1.02);
		}

		/* Tickets */
		.tickets-grid {
			display: flex;
			flex-direction: column;
			gap: .9rem;
		}
		.ticket-card {
			background: var(--bg-surface);
			border: 1px solid var(--border-color);
			border-radius: var(--radius-card);
			padding: 1rem;
			margin-top:1.45rem;
			text-decoration: none;
			display: flex;
			flex-direction: row;
			align-items: center;
			justify-content: flex-start;
			text-align: left;
			transition: var(--transition);
			filter: contrast(0.9);
			user-select: none;
		}
		.ticket-card:hover {
			transform: translateY(4px);
			box-shadow: 0 10px 30px var(--card-shadow-light);
			border: 1px solid rgba(52,52,52,0.10);
			filter: contrast(1) brightness(1.02);
		}
		.ticket-card.disabled {
			cursor: default;
			pointer-events: none;
			touch-action: none;
			transition: none;
			opacity:.5;
			filter:contrast(1) brightness(1);
			&:hover{filter:contrast(1) brightness(1);}
		}

		.ticket-icon {
			width: 50px;
			height: 50px;
			border-radius: 50%;
			background: var(--bg-surface);
			border: 2px solid var(--border-color);
			display: flex;
			align-items: center;
			justify-content: center;
			margin-right: 1rem;
		}
		.ticket-icon i { font-size: 1.75rem; color: var(--text-primary); }
		.ticket-info { display: flex; flex-direction: column; align-items: flex-start; }
		.ticket-name { font-size: 1.25rem; font-weight: 900; margin-bottom: .15rem; color: var(--text-primary); }
		.ticket-cta { font-size: .875rem; font-weight: 700; color: var(--text-secondary); }

		.apollo-coupon-detail {
			background: rgba(247, 148, 27, 0.08);
			border: 1px dashed var(--border-color);
			border-radius: 0 0 12px 12px;
			padding: .5rem .6rem .3rem .6rem;
			display: flex;
			align-items: center;
			gap: 0.84rem;
			font-size: 0.78rem;
			letter-spacing: .5px;
		}
		.apollo-coupon-detail span { margin:auto; align-text:center}
		.apollo-coupon-detail strong {
			font-size: 0.75rem;
			position:relative;
			display:inline-flex;
			font-weight: 800;
			text-align: center;
			margin:auto;
			color: var(--text-primary);
			letter-spacing: 1px;
		}
		.apollo-coupon-detail .ri-coupon-3-line {
			font-size: .99rem;
			padding: .3rem 0;
			color: var(--text-secondary);
			transform: rotate(145deg);
		}
		.copy-code-mini {
			background: transparent;
			border: none;
			color: var(--text-secondary);
			border-radius: 3px;
			width: 17px;
			height: 17px;
			display: flex;
			align-items: center;
			justify-content: center;
			cursor: pointer;
			margin-left: auto;
			transition: var(--transition);
			transform:rotate(0deg);
		}
		.copy-code-mini i { font-size: 1.05rem; }
		.copy-code-mini:hover { background: rgba(19,21,23,.08); }

		/* Bottom bar */
		.bottom-bar {
			position: fixed;
			bottom: 0;
			left: 50%;
			transform: translateX(-50%);
			width: 100%;
			max-width: 500px;
			background: rgba(255, 255, 255, 0.95);
			backdrop-filter: blur(20px);
			padding: 1rem 1.5rem;
			box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
			z-index: 100;
			display: flex;
			gap: 0.75rem;
			border-radius: 22px 22px 0 0;
		}
		.bottom-btn {
			flex: 1;
			padding: 1rem;
			border-radius: var(--radius-main);
			border: 1px solid var(--border-color);
			font-weight: 900;
			font-size: 0.95rem;
			cursor: pointer;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 0.5rem;
			transition: var(--transition);
			text-decoration: none;
			background: var(--bg-main);
			color: var(--text-primary);
		}
		.bottom-btn:active { transform: scale(0.97); }
		.bottom-btn:hover { background: var(--bg-surface); border-color: var(--text-secondary); }
		.bottom-btn.primary {
			background: var(--text-primary);
			color: #fff;
			border-color: var(--text-primary);
		}
		.bottom-btn.primary:hover {
			background: var(--text-secondary);
			border-color: var(--text-secondary);
		}

		/* Responsive */
		@media (max-width: 768px) {
			.hero-media { height: 60vh; }
			.quick-actions {
				grid-template-columns: repeat(4, auto);
				gap: 0;
				padding: 0.1rem 1rem 0 1rem;
				margin: 1.5rem auto 0px auto;
			}
			.rsvp-row { padding: 2rem 2rem 2rem; margin: 0.7rem auto; }
			.interested-text { right: -55px; }
			.avatars-explosion { right: 70px; }
			.local-images-slider { height: 250px; }
			.avatar { width: 36px; height: 36px; }
			.lineup-avatar-img, .lineup-avatar-fallback {
				width: 30%;
				height: 60px;
				font-size: 1.5rem;
			}
		}
	</style>
</head>

<body>
<div class="mobile-container">

	<!-- ======================= HERO ======================= -->
	<div class="hero-media">
		<div class="video-cover">
			<?php if ( $youtube_embed ) : ?>
				<iframe
					src="<?php echo esc_url( $youtube_embed ); ?>"
					allow="autoplay; fullscreen"
					allowfullscreen
					frameborder="0"
				></iframe>
			<?php else : ?>
				<img src="<?php echo esc_url( $featured_img ); ?>" alt="<?php echo esc_attr( $event_title ); ?>">
			<?php endif; ?>
		</div>

		<div class="hero-overlay"></div>

		<div class="hero-content">
			<h1 class="hero-title"><?php echo esc_html( $event_title ); ?></h1>

			<div class="hero-meta">
				<?php if ( $event_date_display ) : ?>
					<div class="hero-meta-item">
						<i class="ri-calendar-line"></i>
						<span><?php echo esc_html( $event_date_display ); ?></span>
					</div>
				<?php endif; ?>

				<?php if ( $event_start_time || $event_end_time ) : ?>
					<div class="hero-meta-item">
						<i class="ri-time-line"></i>
						<span id="Hora"><?php echo esc_html( trim( $event_start_time . ' - ' . $event_end_time ) ); ?><font style="opacity:.7;font-weight:300; font-size:.81rem; vertical-align: bottom;">(GMT-03h00)</font></span>
					</div>
				<?php endif; ?>

				<?php if ( $event_city ) : ?>
					<div class="hero-meta-item">
						<i class="ri-map-pin-line"></i>
						<span><?php echo esc_html( $event_city ); ?></span>
					</div>
				<?php endif; ?>
			</div>
		</div>
	</div>

	<!-- ======================= BODY ======================= -->
	<div class="event-body">

		<!-- Quick actions -->
		<div class="quick-actions">
			<a href="#route_TICKETS" class="quick-action">
				<div class="quick-action-icon"><i class="ri-ticket-2-line"></i></div>
				<span class="quick-action-label">TICKETS</span>
			</a>
			<a href="#route_LINE" class="quick-action">
				<div class="quick-action-icon"><i class="ri-draft-line"></i></div>
				<span class="quick-action-label">Line-up</span>
			</a>
			<a href="#route_ROUTE" class="quick-action">
				<div class="quick-action-icon"><i class="ri-treasure-map-line"></i></div>
				<span class="quick-action-label">ROUTE</span>
			</a>
			<a href="#" class="quick-action" id="favoriteTrigger">
				<div class="quick-action-icon">
					<i class="ri-rocket-line"></i>
				</div>
				<span class="quick-action-label">Interesse</span>
			</a>
		</div>

		<!-- Interested avatars (REAL) -->
		<div class="rsvp-row">
			<div class="avatars-explosion" id="apolloAvatars">
				<?php
				foreach ( $visible_ids as $uid ) :
					$avatar_url = get_avatar_url( $uid, array( 'size' => 96 ) );
					if ( ! $avatar_url ) {
						continue;
					}
					?>
					<div class="avatar" style="background-image:url('<?php echo esc_url( $avatar_url ); ?>');" title="<?php echo esc_attr( get_the_author_meta( 'display_name', $uid ) ); ?>"></div>
				<?php endforeach; ?>

				<?php if ( $hidden_count > 0 ) : ?>
					<div class="avatar-count" id="apolloAvatarCount">+<?php echo esc_html( (string) $hidden_count ); ?></div>
				<?php else : ?>
					<div class="avatar-count" id="apolloAvatarCount" style="display:none;"></div>
				<?php endif; ?>
			</div>

			<p class="interested-text" style="margin: 0 8px 0px 20px;">
				<i class="ri-bar-chart-2-fill"></i> <span id="result"><?php echo esc_html( (string) $total_interested ); ?></span>
			</p>
		</div>

		<!-- Info -->
		<section class="section">
			<h2 class="section-title">
				<i class="ri-brain-ai-3-fill"></i> Info
			</h2>
			<div class="info-card">
				<div class="info-text">
					<?php the_content(); ?>
				</div>
			</div>

			<?php if ( ! empty( $sounds ) ) : ?>
				<div class="music-tags-marquee">
					<div class="music-tags-track">
						<?php foreach ( $sounds as $s ) : ?>
							<span class="music-tag"><?php echo esc_html( $s ); ?></span>
						<?php endforeach; ?>
					</div>
				</div>
			<?php endif; ?>
		</section>

		<!-- Line-up -->
		<section class="section" id="route_LINE">
			<h2 class="section-title"><i class="ri-disc-line"></i> Line-up</h2>

			<?php if ( ! empty( $dj_slots ) ) : ?>
				<div class="lineup-list">
					<?php
					foreach ( $dj_slots as $slot ) :
						$dj_id = (int) ( $slot['dj_id'] ?? 0 );
						if ( ! $dj_id ) {
							continue;
						}

						$dj_title = get_the_title( $dj_id );
						$dj_link  = get_permalink( $dj_id );
						$dj_img   = get_the_post_thumbnail_url( $dj_id, 'medium' );
						$start    = (string) ( $slot['start'] ?? '' );
						$end      = (string) ( $slot['end'] ?? '' );
						?>
						<div class="lineup-card">
							<?php if ( $dj_img ) : ?>
								<img class="lineup-avatar-img" src="<?php echo esc_url( $dj_img ); ?>" alt="<?php echo esc_attr( $dj_title ); ?>">
							<?php else : ?>
								<div class="lineup-avatar-fallback"><?php echo esc_html( apollo_initials( $dj_title ) ); ?></div>
							<?php endif; ?>

							<div class="lineup-info">
								<h3 class="lineup-name">
									<a href="<?php echo esc_url( $dj_link ); ?>" target="_blank" rel="noopener noreferrer" class="dj-link">
										<?php echo esc_html( $dj_title ); ?>
									</a>
								</h3>

								<?php if ( $start || $end ) : ?>
									<div class="lineup-time"><i class="ri-time-line"></i><span><?php echo esc_html( trim( $start . ' - ' . $end ) ); ?></span></div>
								<?php endif; ?>
							</div>
						</div>
					<?php endforeach; ?>
				</div>
			<?php else : ?>
				<p style="opacity:.7;">Line-up ainda não informado.</p>
			<?php endif; ?>
		</section>

		<!-- Route + Map -->
		<section class="section" id="route_ROUTE">
			<h2 class="section-title">
				<i class="ri-map-pin-2-line"></i> <?php echo esc_html( $event_city ?: 'Local' ); ?>
			</h2>
			<?php if ( $event_address ) : ?>
				<p style="margin:0.5rem 0 1.5rem 0; font-size:0.95rem;"><?php echo esc_html( $event_address ); ?></p>
			<?php endif; ?>

			<div class="ap-map-shell">
				<div class="ap-map-bg"></div>

				<div
					id="apolloEventMap"
					class="ap-map-canvas"
					data-lat="<?php echo esc_attr( $coords['lat'] !== null ? (string) $coords['lat'] : '' ); ?>"
					data-lng="<?php echo esc_attr( $coords['lng'] !== null ? (string) $coords['lng'] : '' ); ?>"
					data-title="<?php echo esc_attr( $event_title ); ?>"
					data-address="<?php echo esc_attr( (string) $event_address ); ?>"
				></div>

				<div class="ap-map-overlay-fade"></div>
			</div>

			<div class="route-controls">
				<div class="route-input">
					<i class="ri-map-pin-line"></i>
					<input type="text" id="origin-input" placeholder="Seu endereço de partida">
				</div>
				<button id="route-btn" class="route-button">
					<i class="ri-send-plane-line"></i>
				</button>
			</div>
		</section>

		<!-- Tickets -->
		<section class="section" id="route_TICKETS">
			<h2 class="section-title">
				<i class="ri-ticket-2-line" style="margin:2px 0 -2px 0"></i> Acessos
			</h2>

			<div class="tickets-grid">
				<?php if ( $tickets_url ) : ?>
					<a href="<?php echo esc_url( $tickets_url ); ?>" class="ticket-card" target="_blank" rel="noopener noreferrer">
						<div class="ticket-icon"><i class="ri-ticket-line"></i></div>
						<div class="ticket-info">
							<h3 class="ticket-name"><span id="changingword">Biglietti</span></h3>
							<span class="ticket-cta">Acessar Bilheteria Digital →</span>
						</div>
					</a>

					<div class="apollo-coupon-detail">
						<i class="ri-coupon-3-line"></i>
						<span>Verifique se o cupom <strong><?php echo esc_html( (string) $coupon_code ); ?></strong> está ativo com desconto</span>
						<button class="copy-code-mini" onclick="copyPromoCode()">
							<i class="ri-file-copy-fill"></i>
						</button>
					</div>
				<?php else : ?>
					<div class="ticket-card disabled">
						<div class="ticket-icon"><i class="ri-ticket-line"></i></div>
						<div class="ticket-info">
							<h3 class="ticket-name">Bilheteria</h3>
							<span class="ticket-cta">Em breve →</span>
						</div>
					</div>
				<?php endif; ?>

				<?php if ( $guestlist_url ) : ?>
					<a href="<?php echo esc_url( $guestlist_url ); ?>" class="ticket-card" target="_blank" rel="noopener noreferrer">
						<div class="ticket-icon">
							<i class="ri-list-check"></i>
						</div>
						<div class="ticket-info">
							<h3 class="ticket-name">Lista Amiga</h3>
							<span class="ticket-cta">Ver Lista Amiga →</span>
						</div>
					</a>
				<?php else : ?>
					<div class="ticket-card disabled">
						<div class="ticket-icon">
							<i class="ri-list-check"></i>
						</div>
						<div class="ticket-info">
							<h3 class="ticket-name">Lista Amiga</h3>
							<span class="ticket-cta">Indisponível →</span>
						</div>
					</div>
				<?php endif; ?>
			</div>
		</section>

		<!-- spacer so bottom bar doesn't cover content -->
		<div style="height:120px;"></div>

	</div><!-- /event-body -->

	<!-- Bottom Bar -->
	<div class="bottom-bar">
		<?php if ( $tickets_url ) : ?>
			<a href="#route_TICKETS" class="bottom-btn primary" id="bottomTicketBtn">
				<i class="ri-ticket-fill"></i>
				<span id="changingword">Tickets</span>
			</a>
		<?php else : ?>
			<a href="#route_TICKETS" class="bottom-btn primary" id="bottomTicketBtn">
				<i class="ri-ticket-fill"></i>
				<span>Detalhes</span>
			</a>
		<?php endif; ?>

		<button class="bottom-btn secondary" id="bottomShareBtn">
			<i class="ri-share-forward-line"></i>
		</button>
	</div>

</div><!-- /mobile-container -->

<script>
(function(){
	'use strict';

	// Bottom Ticket word animation
	var words = ['Entradas','Ingressos','Billets','Ticket','Acessos','Biglietti'];
	var i = 0;
	var el = document.getElementById('changingword');
	if (el) {
		el.textContent = words[i];
		setInterval(function(){
			i = (i + 1) % words.length;
			el.style.opacity = 0;
			setTimeout(function(){
				el.textContent = words[i];
				el.style.opacity = 1;
			}, 220);
		}, 4000);
	}

	// Copy Promo Code
	function copyPromoCode() {
		const code = '<?php echo esc_js( $coupon_code ); ?>';
		navigator.clipboard.writeText(code).then(() => {
			const btn = event.target.closest('.copy-code-mini');
			const originalHTML = btn.innerHTML;
			btn.innerHTML = '<i class="ri-check-line"></i>';
			setTimeout(() => {
				btn.innerHTML = originalHTML;
			}, 2000);
		});
	}

	// Share Function
	document.getElementById('bottomShareBtn')?.addEventListener('click', () => {
		if (navigator.share) {
			navigator.share({
				title: '<?php echo esc_js( $event_title ); ?>',
				text: 'Confere esse evento no Apollo::rio!',
				url: window.location.href
			});
		} else {
			navigator.clipboard.writeText(window.location.href);
			alert('Link copiado!');
		}
	});

	// Route Button
	const routeBtn = document.getElementById('route-btn');
	if (routeBtn) {
		routeBtn.addEventListener('click', () => {
			const originInput = document.getElementById('origin-input');
			const origin = originInput.value;
			if (origin) {
				const destination = '<?php echo esc_js( $event_address ?: $event_city ); ?>';
				window.open(`https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`, '_blank');
			} else {
				originInput.placeholder = 'Por favor, insira um endereço!';
				setTimeout(() => {
					originInput.placeholder = 'Seu endereço de partida';
				}, 2000);
			}
		});
	}

	// Leaflet map init
	function initLeafletMap() {
		var mapEl = document.getElementById('apolloEventMap');
		if (!mapEl) return;
		if (typeof window.L === 'undefined') return;

		var lat = mapEl.getAttribute('data-lat');
		var lng = mapEl.getAttribute('data-lng');

		if (!lat || !lng) return;

		var latNum = parseFloat(lat);
		var lngNum = parseFloat(lng);
		if (isNaN(latNum) || isNaN(lngNum)) return;

		var map = window.L.map('apolloEventMap', {
			zoomControl: true,
			attributionControl: true
		}).setView([latNum, lngNum], 14);

		window.L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
			maxZoom: 19,
			attribution: '&copy; OpenStreetMap contributors'
		}).addTo(map);

		var title = mapEl.getAttribute('data-title') || '';
		var address = mapEl.getAttribute('data-address') || '';
		var popup = '<strong>' + (title || 'Evento') + '</strong>' + (address ? '<br>' + address : '');

		window.L.circleMarker([latNum, lngNum], {
			radius: 8,
			weight: 3,
			opacity: 1,
			fillOpacity: 0.95
		}).addTo(map).bindPopup(popup);

		setTimeout(function(){ map.invalidateSize(); }, 250);
	}

	initLeafletMap();
	window.addEventListener('load', initLeafletMap);

	// Interesse toggle
	document.getElementById('favoriteTrigger').addEventListener('click', function(event) {
		event.preventDefault();

		const iconContainer = this.querySelector('.quick-action-icon');
		const icon = iconContainer.querySelector('i');
		const avatarsContainer = document.querySelector('.avatars-explosion');
		const countEl = avatarsContainer.querySelector('.avatar-count');
		const resultEl = document.getElementById('result');
		const maxVisible = 10;

		function updateResult() {
			const visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
			const hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
			resultEl.textContent = visibleCount + hiddenCount;
		}

		if (icon.classList.contains('ri-rocket-line')) {
			// Favorite action
			iconContainer.classList.add('fly-away');

			setTimeout(() => {
				iconContainer.classList.remove('fly-away');
				icon.className = 'ri-ai-agent-fill fade-in';
				iconContainer.style.borderColor = 'rgba(0,0,0,0.2)';
			}, 1500);

			let hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
			let visibleCount = avatarsContainer.querySelectorAll('.avatar').length;

			if (visibleCount < maxVisible) {
				const newAvatar = document.createElement('div');
				newAvatar.classList.add('avatar');
				const gender = Math.random() < 0.5 ? 'men' : 'women';
				const id = Math.floor(Math.random() * 99) + 1;
				newAvatar.style.backgroundImage = `url('https://randomuser.me/api/portraits/${gender}/${id}.jpg')`;
				avatarsContainer.insertBefore(newAvatar, countEl);
			} else {
				hiddenCount += 1;
				countEl.textContent = `+${hiddenCount}`;
			}

			updateResult();
		} else {
			// Unfavorite action
			let hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
			let visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
			let total = visibleCount + hiddenCount;

			if (total > 0) {
				if (hiddenCount > 0) {
					hiddenCount -= 1;
					countEl.textContent = hiddenCount > 0 ? `+${hiddenCount}` : '';
				} else if (visibleCount > 0) {
					const lastAvatar = avatarsContainer.querySelector('.avatar:last-of-type');
					if (lastAvatar) lastAvatar.remove();
				}
				updateResult();
			}

			icon.className = 'ri-rocket-line fade-in';
		}
	});

	// Initial update
	const avatarsContainer = document.querySelector('.avatars-explosion');
	const countEl = avatarsContainer.querySelector('.avatar-count');
	const resultEl = document.getElementById('result');

	function initialUpdateResult() {
		const visibleCount = avatarsContainer.querySelectorAll('.avatar').length;
		const hiddenCount = parseInt(countEl.textContent.replace('+', '')) || 0;
		resultEl.textContent = visibleCount + hiddenCount;
	}

initialUpdateResult();
</script>
</body>
</html>
